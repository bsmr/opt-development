#!/bin/bash

action_usage() {
	cat <<EOF
usage: $O [setup|help]
EOF
}

action_setup() {
	# Some personal environmen settings
	#export ERLARCS="${HOME}/Downloads/erlang.org"
	export ERLARCS="/public/Software/Downloads/erlang.org"
	#export ERLSBAS="${HOME}/devel/source/system/erlang/otp"
	export ERLSBAS="${HOME}/source/system/erlang/otp"
	#export ERLSVER="R14B04"
	#export ERLSVER="R15B"
	export ERLSVER="R15B01"
	#export ERLSVER="git"
	#http://www.erlang.org/download/otp_src_R15B.tar.gz
	#export ERLURLD="http://www.erlang.org/download/otp_src_${ERLSVER}.tar.gz"
	export ERLSNAM="otp_src_${ERLSVER}"
	export ERLSTAR="${ERLSNAM}.tar.gz"
	export BUILDTS=$(date --utc '+%Y%m%d-%H%M')
	export PREFIX="/opt/erlang/otp/${ERLSVER}/${BUILDTS}"
	#export ERLLINK="/opt/erlang-otp"

	# Setup the source environment
	test ! -d "${ERLSBAS}" && mkdir -p "${ERLSBAS}"
	cd "${ERLSBAS}"
	tar xvf "${ERLARCS}/${ERLSTAR}"
	cd "${ERLSNAM}"

	# change to source
	#cd "/home/family/bsmr/source/repos/github.com/otp"

	# Some needed enviroment settings
	export ERL_TOP="`pwd`"
	export PATH="$ERL_TOP/bin:$PATH"
	export LANG="C"

	# special git actions
	#./otp_build autoconf

	# Configure
	/usr/bin/time ./configure --prefix="${PREFIX}" --with-gmp 2>&1 | tee "log-1-configure.txt"

	# Compile and install
	/usr/bin/time make all		2>&1 | tee "log-2-build_system.txt"
	/usr/bin/time make install	2>&1 | tee "log-3-install_system.txt"
	/usr/bin/time make docs		2>&1 | tee "log-4-build_docs.txt"
	/usr/bin/time make install-docs	2>&1 | tee "log-5-install_docs.txt"

	# Create a directory with shortcuts to all PDFs
	cd ${PREFIX}
	mkdir pdf
	cd pdf
	find "${PREFIX}/lib/erlang" -type f -name '*.pdf' -exec ln -sf "{}" \;

	# make life easier
	#test -h "${ERLLINK}" && rm -f "${ERLLINK}"
	#ln -sf "${PREFIX}" "${ERLLINK}"
}

case $1 in
	setup)
		action_setup
		;;
	help)
		action_usage
		;;
	*)
		action_usage
		exit 1
		;;
esac

exit 0

# EOF
