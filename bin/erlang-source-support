#!/bin/bash

action_usage() {
	cat <<EOF
usage: $O [setup|help]
EOF
}

action_setup() {
	#TIME="/usr/bin/time"
	TIME=""
	# Some personal environmen settings
	ERLARCS="/public/Software/Downloads/erlang.org"
	ERLSBAS=$(mktemp -d --suffix="-erlang-otp")
	ERLSVER="R15B01"
	ERLSNAM="otp_src_${ERLSVER}"
	ERLSTAR="${ERLSNAM}.tar.gz"
	BUILDTS=$(date --utc '+%Y%m%d-%H%M')
	OPTERL="/opt/erlang/otp"
	PREFIX="${OPTERL}/${ERLSVER}/${BUILDTS}"
	ERLLINK="${OPTERL}/active"
	TITLE="+++ ACTION:"

	# Setup the source environment
	echo "${TITLE} extracking source"
	test ! -d "${ERLSBAS}" && mkdir -p "${ERLSBAS}"
	cd "${ERLSBAS}"
	tar xf "${ERLARCS}/${ERLSTAR}"
	cd "${ERLSNAM}"

	# Some needed enviroment settings
	echo "${TITLE} setting environment"
	export ERL_TOP=$(pwd)
	export PATH="$ERL_TOP/bin:$PATH"
	export LANG="C"

	# Configure
	echo "${TITLE} configure"
	${TIME} ./configure --prefix="${PREFIX}" --with-gmp

	# Compile and install
	for ACT in "all" "install" "docs" "install-docs"
	do
		echo "${TITLE} make ${ACT}"
		${TIME} make ${ACT}
	done

	# Create a directory with shortcuts to all PDFs
	echo "${TITLE} link PDFs"
	cd "${PREFIX}"
	mkdir "pdf"
	cd "pdf"
	find "${PREFIX}/lib/erlang" -type f -name '*.pdf' -exec ln -sf "{}" \;

	# make life easier
	echo "${TITLE} setup link"
	if [ -n "${ERLLINK}" ]
	then
		if [ -h "${ERLLINK}" ]
		then
			rm -f "${ERLLINK}"
		fi
		ln -sf "${PREFIX}" "${ERLLINK}"
	fi

	echo "${TITLE} cleanup"
	rm -rf "${ERLSBAS}"
}

case $1 in
	setup)
		action_setup
		;;
	help)
		action_usage
		;;
	*)
		action_usage
		exit 1
		;;
esac

exit 0

# EOF
