#!/bin/bash

BLENDER_BASE="${HOME}/source/repos/blender.org"
BLENDER_SVN_SOURCE="${BLENDER_BASE}/blender"
BLENDER_SVN_BUILD="${BLENDER_BASE}/blender-build"

action_usage() {
	cat <<EOF
Usage: $0 [update]
EOF
}

action_update() {
	if [ -d "${BLENDER_SVN_SOURCE}" ] ; then
		cd "${BLENDER_SVN_SOURCE}"
		svn update
	fi
	LANG="C"
	#CPUCOUNT=$(cat /proc/cpuinfo | grep processor | wc -l)
	#CPUCOUNT=$(($(nproc) + 1))
	CPUCOUNT=""
	if [ -n "$CPUCOUNT" -a "$CPUCOUNT" > "1" ]
	then
		PM="-j${CPUCOUNT}"
	fi
	#PATH="/opt/python/active/bin:$PATH"
	PYTHON_ROOT_DIR="/opt/python/3.3.0"
	PYTHON_LIBRARY="${PYTHON_ROOT_DIR}/lib/python3.3"
	PYTHON_LIBPATH="${PYTHON_ROOT_DIR}/lib/python3.3"
	PYTHON_INCLUDE_DIR="${PYTHON_ROOT_DIR}/include/python3.3m"
	PYTHON_INCLUDE_CONFIG_DIR="${PYTHON_ROOT_DIR}/include/python3.3m"
export PYTHON_ROOT_DIR PYTHON_LIBRARY PYTHON_LIBPATH PYTHON_INCLUDE_DIR PYTHON_INCLUDE_CONFIG_DIR
	PATH="${PYTHON_ROOT_DIR}/bin:${PATH}"
export PATH
	BOOST_ROOT="/opt/boost/1.52.0"
	#BOOST_INC_DIR="${BOOST_ROOT}/include/boost"
	BOOST_INC_DIR="${BOOST_ROOT}/include"
	BOOST_LIB_DIR="${BOOST_ROOT}/lib"
	if [ -d "${BLENDER_SVN_BUILD}" ] ; then
		rm -rf "${BLENDER_SVN_BUILD}"
	fi
	mkdir -p "${BLENDER_SVN_BUILD}"					\
	&& cd "${BLENDER_SVN_BUILD}"					\
	&& cmake	"${BLENDER_SVN_SOURCE}"				\
			"-DCMAKE_INSTALL_PREFIX=/opt/blender/svn"	\
			"-DWITH_INSTALL_PORTABLE=OFF"			\
			"-DWITH_CYCLES=OFF"				\
			"-DBOOST_ROOT=/opt/boost/1.52.0"		\
			"-DBOOST_CUSTOM=1"				\
			"-DBoost_INCLUDE_DIRS=${BOOST_INC_DIR}"		\
			"-DBoost_LIBRARY_DIRS=${BOOST_LIB_DIR}"		\
	&& make ${PM}							\
	&& make install
	#		"-DWITH_PYTHON=${PYTHON_ROOT_DIR}"
}

case $1 in
update)
	action_update
	;;
*)
	action_usage
	exit 1
	;;
esac

exit 0

#
# End Of File
#
